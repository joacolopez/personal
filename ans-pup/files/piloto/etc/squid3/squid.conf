# Configuracion para proxy local en filiales VPN.
# Modificado para Nodos V5.
#
# Version 1.3.10 - 1-Ago-2017
#	Cambia ACL para correoargentino por pasar su URL a SSL y permisos CONNECT
#
# Version 1.3.9 - 10-nov-2016
#	Se suman FQDNs  .sba.redlink.com.ar .symcb.com .geotrust.com .download.windowsupdate.com de IntenetSinBandaHoraria a bulk-FQDN
#	Para asegurar el trafico desde los totems FDV (fe de vida)
#
# Version 1.3.8 - 16-feb-2016
#       Se agrega permiso para cabal individuos smpc.cabal.coop a la nomina de internet sin restriccion horaria
#
# Version 1.3.5 - 21-dic-2015
#       Se quita .enteley22400.org.ar a la nomina de internet sin restriccion horaria.
#
# Version 1.3.4 - 26-nov-2015
#       Se agrega .enteley22400.org.ar a la nomina de internet sin restriccion horaria.
#
# Version 1.3.3 - 10-Agosto-2015
#       Se agrega a InternetSinBandaHoraria-FQDN .sba.redlink.com.ar .symcb.com .geotrust.com para enrolamiento de jubilados.
#
# Versión 1.3.1 - 13/05/2013 -
#	Se agregan ACLs para proxiar puppetmaster de nodosVPN.
#	Permisos para Futbolcoop.coop
#
# Version 1.3 - 11/10/2013 -
#	Se agrega QoS para Download y Upload -> Zimbra
# 	ACL -> bulk-QoS-REG
# 
# 
# Proyectos Especiales.
# Gerencia de tecnologia.

# Manejo de errores en castellano
error_directory /usr/share/squid/errors/Spanish
#====== Access List Control ==============================================

# ---- ACLs Generales ----------------------------------------------------

acl all src 0.0.0.0/0.0.0.0
acl manager proto cache_object
acl localhost src 127.0.0.1/255.255.255.255
acl to_localhost dst 127.0.0.0/8
acl SSL_ports port 443 8443 21 20 9443 8140
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl Safe_ports port 8140	# puppet SCM
acl CONNECT method CONNECT
acl purge method PURGE

acl ftp proto FTP

acl our_networks src 10.0.0.0/8 127.0.0.1


# ---- ACLs por clase (Prio1) => HiCritical ------------------------------
acl prio1-FQDN dstdomain crecerxxi.bancocredicoop.coop cas.bancocredicoop.coop sitiafip.bancocredicoop.coop sso.bancocredicoop.coop
acl prio1-IP dst 10.128.6.10 10.160.6.10 10.136.8.58 10.136.8.59


# ---- ACLs por clase (Prio2) => Critical --------------------------------
acl prio2-FQDN dstdomain .bancocredicoop.coop
acl prio2-IP dst 10.3.3.35
# 10.3.3.35 es RTP sobre HTTP (Videoconferencia).


# ---- ACLs por clase (Bulk) => Default ----------------------------------
acl bulk-FQDN dstdomain .centrocultural.coop .afip.gov.ar .afip.gob.ar addons.mozilla.org fxfeeds.mozilla.com .jus.gob.ar .jus.gov.ar .sba.redlink.com.ar .symcb.com .geotrust.com .download.windowsupdate.com
acl bulk-IP dst 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
acl bulk-QoS-REG url_regex -i ^https?://correo\.bancocredicoop\.coop/service/home/\~/.*$
acl bulk-REG url_regex -i ^http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif ^http://www.google-analytics.com/ga.js ^http://www.w3.org/Icons/valid-xhtml10 ^http://jigsaw.w3.org/css-validator/images/vcss-blue

# ---- ACLs DIRECTO, Sin proxy padre (Bulk) ----------------------------------
acl puppetmaster-FQDN dstdomain puppetmaster.bancocredicoop.coop


# Por afip se habilito:
# 	1) bulk-REG el 100%
#	2) addons.mozilla.org fxfeeds.mozilla.com 

# ---- URL de internet sin restricciones de usuario. ---------------------
# Estas, ademas de incluirse en BULK mas adelante, tiene 
# Restricciones horarias y de ancho de banda.
# SOLME es de beneficios para empleados, sin restricción horaria.

acl InternetBandaHoraria-FQDN dstdomain .gov.ar .gob.ar .futbolcoop.coop
acl InternetSinBandaHoraria-FQDN dstdomain .beneficios-solme.com .bcra.gov.ar .bcra.gob.ar tag.perfectaudience.com smpc.cabal.coop .turismocabal.tur.ar .anses.gov.ar .anses.gob.ar
acl InternetSinBandaHoraria-REG url_regex -i ^https?://www.correoargentino.com.ar ^https?://www.correoargentino.com.ar/cpa  ^https?://www.correoargentino.com.ar/formularios/cpa  ^https?://www.correoargentino.com.ar/img/ ^https?://www.correoargentino.com.ar/favicon.ico ^https?://www.correoargentino.com.ar/assets/  ^https?://www.correoargentino/consultas/cpa/ ^https?://www.correoargentino.com.ar/contacto/versegundo_captcha ^https?://www.correoargentino.com.ar/contacto/ ^https?://www.correoargentino.com.ar/consultas/ ^https?://www.correoargentino.com.ar:443 www.correoargentino.com.ar:443



# Todos los "Internet" pueden bajar paginas de 170Kbytes, si lo superan 
# pasan a tener 128kbps entre todos los clientes.


# ==== GRUPOS PARA BANDAS HORARIAS ========================================
include /etc/squid/GrupoHorario_.txt


# ==== Manejo de BANDAS HORARIAS ==========================================
# --- Uso de Internet para Todos --------------------------------
acl BandaHoraria_1 time 8:30-13:00
acl BandaHoraria_2 time 7:15-12:15
acl BandaHoraria_3 time 10:30-15:00

http_access deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_1 BandaHoraria_1 
http_access deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_2 BandaHoraria_2 
http_access deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_3 BandaHoraria_3 !GrupoHorario_1 !GrupoHorario_2

deny_info ERR_TIME_DENIED deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_1 BandaHoraria_1
deny_info ERR_TIME_DENIED deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_2 BandaHoraria_2 
deny_info ERR_TIME_DENIED deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_3 BandaHoraria_3 

# ==== QoS UpStream por Cliente ===========================================
# Necesita Squid v3.2 o superior.
# Se comenta para Squid v2.7

#client_delay_pools 2

# Sin Limite (default)
#client_delay_class 1 -1/-1

# Cuota de subida: 50 Kbytes.
# Bandwidth subida: 128 kbps.
#client_delay_class 2 16384 51200

# Restriccion de Upstream
#client_delay_access 2 allow bulk-QoS-REG
#client_delay_access 2 deny all

# Sin Restriccion
#client_delay_access 1 deny bulk-QoS-REG
#client_delay_access 1 allow all

# ==== QoS DownStream por URL =============================================
delay_pools 3
delay_class 1 1
delay_class 2 2
delay_class 3 2

# Sin Limite
delay_parameters 1 -1/-1

# Cuota libre de bajada individual: 102400 Bytes (100 Kbyes)
# Superada la cuota individual, pasa a tener 128kbps por estación.
# Cuota libre globlar: 153600 Bytes (150kBytes).
# Superada la cuota global, el BW pasa a 170Kbps (21760).
delay_parameters 2 21760/153600 16384/102400

# Cuota libre individual: 100 Kbytes -> (102400 Bytes).
# Superada cuota individual, ancho de banda:  200 kbps -> (25600 bytes/seg)
# Cuota global libre: 200 KBytes -> (204800 Bytes)-
# Superada cuota global: 300 kbps -> (38400 bytes/seg).
delay_parameters 3 38400/204800 25600/102400

# Restriccion segun pool 3 (QoS - Zimbra) 
delay_access 3 allow bulk-QoS-REG
delay_access 3 deny all

# Con restriccion segun pool 2
delay_access 2 allow InternetSinBandaHoraria-FQDN
delay_access 2 allow InternetBandaHoraria-FQDN 
delay_access 2 allow InternetSinBandaHoraria-REG
delay_access 2 deny all

# Sin limite por ser pool 1
delay_access 1 deny bulk-QoS-REG
delay_access 1 deny InternetSinBandaHoraria-FQDN
delay_access 1 deny InternetBandaHoraria-FQDN
delay_access 1 allow all


# ==== INCLUSION DE CASOS PARTICUALES =====================================
# Estudio Alzaga-Martinez, Segurcoop, DirectGroup, etc.

include /etc/squid/*.squid.conf


# ==== PERMISOS para las ACLs =============================================
# ---- Default ---------------------------------------
http_access allow manager localhost
http_access allow purge localhost
http_access allow CONNECT localhost safe_ports puppetmaster-FQDN
http_access allow CONNECT InternetSinBandaHoraria-REG
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow our_networks prio1-FQDN
http_access allow our_networks prio1-IP
http_access allow our_networks prio2-FQDN
http_access allow our_networks prio2-IP
http_access allow our_networks bulk-FQDN
http_access allow our_networks bulk-IP
http_access allow our_networks bulk-REG
http_access allow our_networks InternetSinBandaHoraria-FQDN 
http_access allow our_networks InternetSinBandaHoraria-REG 
http_access allow our_networks InternetBandaHoraria-FQDN 

http_access deny all

# ==== GENERALIDADES y DEMÁS CONFIGURACIONES ================================
# Agrega a una URL con hostname (sin puntos) el dominio credicoop.
append_domain .bancocredicoop.coop

icp_access allow all

http_port 3128

dns_nameservers 127.0.0.1 10.1.1.3 10.1.1.9

balance_on_multiple_ip on

positive_dns_ttl 10 minutes
negative_dns_ttl 10 minutes


hierarchy_stoplist cgi-bin ?

acl QUERY urlpath_regex cgi-bin \?
cache deny QUERY

cache_dir diskd /var/spool/squid 10000 16 256

logfile_rotate 0

log_mime_hdrs off

refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern .		0	20%	4320

acl apache rep_header Server ^Apache
broken_vary_encoding allow apache

forward_timeout 2 minutes

cache_effective_user proxy
cache_effective_group proxy

always_direct allow localhost puppetmaster-FQDN
always_direct deny all
never_direct allow all 

access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none


# ==== Proxies padre y manejo de prioridades ================================
# Este invoca al link que apunta a WanProxy o Proxyfil.bancocredicoop.coop --
include /etc/squid/cache_peers.conf

# Distribución de tráfico por peer.------------------------------------------

cache_peer_access prio1 allow prio1-FQDN
cache_peer_access prio1 allow prio1-IP
cache_peer_access prio1 deny all

cache_peer_access prio2 deny prio1-FQDN
cache_peer_access prio2 deny prio1-IP
cache_peer_access prio2 deny bulk-QoS-REG
cache_peer_access prio2 allow prio2-FQDN
cache_peer_access prio2 allow prio2-IP
cache_peer_access prio2 deny all

cache_peer_access bulk allow bulk-QoS-REG
cache_peer_access bulk deny prio1-FQDN
cache_peer_access bulk deny prio1-IP
cache_peer_access bulk deny prio2-FQDN
cache_peer_access bulk deny prio2-IP
cache_peer_access bulk allow bulk-FQDN
cache_peer_access bulk allow bulk-IP
cache_peer_access bulk allow bulk-REG
cache_peer_access bulk allow !FTP bulk-SrvSegucoopFQDN
cache_peer_access bulk allow !FTP bulk-SrvSegucoopIP
cache_peer_access bulk allow InternetBandaHoraria-FQDN
cache_peer_access bulk allow InternetSinBandaHoraria-FQDN
cache_peer_access bulk allow InternetSinBandaHoraria-REG
cache_peer_access bulk deny all

httpd_suppress_version_string on

#visible_hostname NodoVPN

# DEBUG, argumento 1=seccion , argumento 2=vebosity 1 menos y 9 max.
#debug_options ALL,2 
#debug_options ALL,1 33,2

