PATH: /etc/dhcp/dhcpd.conf
# Version de puppet 1.4 - 27-Jul-2020
#	Pool la UPS
# Version de puppet 1.3 - 16-Dic-2019
# Inclusion de multiples segmentos para nuevas estaciones de filial.
# Se agrega función de UCASE para evitar errores de syntaxis.
# ==================================================================
class "EquiposTelefonicos" {
	match if 
	# MACs de YeaLink
	(substring (hardware, 1, 3) = 00:15:65) or 
	# hostname que arranca con ATA
	(ucase(substring(option host-name,0,3)) = "ATA") ;
}

# Switches Cisco/Linksys
class "Switches" {
	# Los nombres de host para los Switches, deben empezar con TOR
	match if 
	(ucase(substring(option host-name,0,3)) = "TOR") or
	(ucase(substring(option host-name,0,2)) = "SW");
}

class "Notebooks" {
	match hardware;
	#match option dhcp-client-identifier;
}
include "/etc/dhcp/dhcpd-subclass-notebooks.conf";

class "videoVigilancia" {
	match if
	(ucase(substring(option host-name,0,3)) = "DVR") or
	(ucase(substring(option host-name,0,4)) = "HCVR") or
	(substring (hardware, 1, 3) = 3c:ef:8c) ;
}

class "CamarasIP" {
	match if
	(ucase(substring(option host-name,0,3)) = "IPC") or
	(substring (hardware, 1, 3) = 14:a7:8b) ;
}

# UPS en la LAN de filiales.
class "UPS" {
    # Los nombres de host deben empezar con UPS
    match if
    (ucase(substring(option host-name,0,3)) = "UPS");
}

# ==================================================================
# Estaciones de trabajo nueva plataforma
class "WorkStations" {
	# Los nombres de host para los puestos, deben empezar con wst
	match if 
	(ucase(substring(option host-name,0,3)) = "WST");
}

# ==================================================================
# Servidores de la LAN de filiales.
class "ServerPVE" {
	# spve Servidor Proxmox (fija en .1) (Hypervisor)
	match if 
	(ucase(substring(option host-name,0,4)) = "SPVE");
}

class "ServerIDrac" {
	# iDrac / ILO / RSA
	match if 
	(ucase(substring(option host-name,0,5)) = "IDRAC");
}

class "ServerANS" {
	# Servidor ANS Bastion Ansible/AWX (estática en .5 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SANS");
}

class "ServerAPT" {
  	# sapt Servidor APT mirror de APT CasaCentral (estática en .6 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SAPT");
}

class "ServerCDN" {
	# scdn Servidor CDN mirror de CDN CasaCentral (estática en .7 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SCDN");
}

class "ServerFTP" {
	# sftp Servidor SFTP repositorio CAFI/GUV (estática en .8 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SFTP");
}

class "ServerGIT" {
	# sgit Servidor GIT mirror de GIT CasaCentral (estática en .9 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SGIT");
}

class "ServerLOG" {
	# slog Servidor Rsyslog (estática en .10 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SLOG");
}

class "ServerPRN" {
	# sprn Servidor de Impresión (estática en .11 )
	match if 
	(ucase(substring(option host-name,0,4)) = "SPRN");
}

class "ServerREP" {
	# srep Servidor de Archivos (estática en .12 )|
	match if 
	(ucase(substring(option host-name,0,4)) = "SREP");
}

class "Servers" {
	# Direccion libre para servers (estática en .13)
	match if 
	(ucase(substring(option host-name,0,3)) = "SRV");
}

class "ServerPXE" {
	# spxe Servidor PXE (estática en .14)
	match if 
	(ucase(substring(option host-name,0,4)) = "SPXE");
}

# ==================================================================
# ==================================================================
ddns-update-style none;
default-lease-time 600;
max-lease-time 7200;
min-lease-time 1800;
log-facility local7;

option wpad code 252 =    text;
# ==================================================================
subnet  %(net_prefix_drago)s.0 netmask 255.255.255.0 {
        one-lease-per-client            on;
        ignore client-updates;		#Ignore all client requests for DDNS update
        default-lease-time 7200;	# Corresponde a una hora
        max-lease-time 14400;		# Corresponde a cuatro horas

        option ip-forwarding            off;
        option subnet-mask              255.255.255.0;
        option broadcast-address        %(net_prefix_drago)s.255;
        option routers                  %(net_prefix_drago)s.254;
        option domain-name              "%(filial_zone)s";
        option domain-search            "bancocredicoop.coop";
        option domain-name-servers      %(net_prefix_drago)s.254, 10.1.2.217;
        option netbios-name-servers     %(net_prefix_drago)s.2;
        option netbios-node-type        8;
        option interface-mtu            1350;

        option smtp-server              smtp.bancocredicoop.coop;
        #option imap-server             imap.bancocredicoop.coop;
        option irc-server               svjab01lx.bancocredicoop.coop;
        option wpad "http://proxyfil.bancocredicoop.coop/proxy.pac\n";

        option time-offset              -10800; # -3:00hs
        option ntp-servers              %(net_prefix_drago)s.254, 10.1.1.88, 10.1.1.89;
        option time-servers             %(net_prefix_drago)s.2;


        # Direcciones IP fijas. Heredado de Nodos v5
        include "/etc/dhcp/dhcpd-ip-fijas.conf";

		# Estaciones de trabajo (linux).------------------------------------------
		# 1er segmento 10.X.Y.16/28 -> (Impresoras).
		# 2do segmento 10.X.Y.32/28 -> (30 hosts para ws).
		# 3er segmento 10.X.Y.64/26 -> (62 hosts para WS).
        pool {
				# Impresoras.
                deny all clients;
                range %(net_prefix_drago)s.17 %(net_prefix_drago)s.30;
        }
        pool {
				# WorkStations. para ambos segmentos.
                allow members of "WorkStations";
                range %(net_prefix_drago)s.33 %(net_prefix_drago)s.122;
        }
        # 2do segmento 10.X.Y.32/28 -> (30 hosts para ws).
		# Pool de direcciones para Notebooks en filiales. Heredado NodoVPN v5.
        # Principalmente ROZ y Auditoría
        pool {
                allow members of "Notebooks";
                #include "/etc/dhcp/dhcp-ws-banco.conf" ;
                range %(net_prefix_drago)s.123 %(net_prefix_drago)s.126;
        }

		# Inicio Segmento de CCTV. 10.X.Y.128/26.---------------------------------
        pool {
				# Camaras
                allow members of "CamarasIP";
                range %(net_prefix_drago)s.129 %(net_prefix_drago)s.184;
        }
        pool {
				# DVRs
                allow members of "videoVigilancia";
                range %(net_prefix_drago)s.185 %(net_prefix_drago)s.190;
        }

		# Segmento reservado para generación de servers.10.X.Y.192/29
        pool {
                deny all clients;
                range %(net_prefix_drago)s.193 %(net_prefix_drago)s.198;
        }

		# pool para telefonos a futuro . 10.X.Y.200/29
		# Hoy son 10.X.Y.168/29 -> Chocaran con Videovigilanci a futuro.
        pool {
                allow members of "EquiposTelefonicos";
                range %(net_prefix_drago)s.201 %(net_prefix_drago)s.206;
        }

        # Rango de direcciones para TAS y FDV. 10.X.Y.208/28
        pool {
                deny all clients;
                range %(net_prefix_drago)s.209 %(net_prefix_drago)s.222;
        }

        # Red ATMs (tiene ip fija) 10.X.Y.224/28.
        pool {
                deny all clients;
                range %(net_prefix_drago)s.225 %(net_prefix_drago)s.238;
        }

        # Segmento libre 10.X.Y.240/29.
        pool {
                deny all clients;
                range %(net_prefix_drago)s.241 %(net_prefix_drago)s.246;
        }

        # Segmento para equipos de comunicaciones. 10.X.Y.248/29.
        pool {
				# 254 , 253 y 252 están reservados para el NodoVPN.
                allow members of "Switches";
                range %(net_prefix_drago)s.249 %(net_prefix_drago)s.251;
                default-lease-time 1800; # Corresponde a 5 horas.
                max-lease-time 28800;   # Corresponde a cuatro horas
                min-lease-time 3600; # Corresponde a 1hs.
        }

        # ################################################ #
		#        Rango para servidores en la filial
        # ################################################ #
        pool {
                allow members of "ServerPVE";
                range %(net_prefix_drago)s.1 %(net_prefix_drago)s.1;
        }
        pool {
                allow members of "ServerIDrac";
                range %(net_prefix_drago)s.3 %(net_prefix_drago)s.4;
	}
        pool {
                allow members of "ServerANS";
                range %(net_prefix_drago)s.5 %(net_prefix_drago)s.5;
	}
        pool {
                allow members of "ServerAPT";
                range %(net_prefix_drago)s.6 %(net_prefix_drago)s.6;
	}
        pool {
                allow members of "ServerCDN";
                range %(net_prefix_drago)s.7 %(net_prefix_drago)s.7;
	}
        pool {
                allow members of "ServerFTP";
                range %(net_prefix_drago)s.8 %(net_prefix_drago)s.8;
	}
        pool {
                allow members of "ServerGIT";
                range %(net_prefix_drago)s.9 %(net_prefix_drago)s.9;
	}
        pool {
                allow members of "ServerLOG";
                range %(net_prefix_drago)s.10 %(net_prefix_drago)s.10;
	}
        pool {
                allow members of "ServerPRN";
                range %(net_prefix_drago)s.11 %(net_prefix_drago)s.11;
	}
        pool {
                allow members of "ServerREP";
                range %(net_prefix_drago)s.12 %(net_prefix_drago)s.12;
	}
        pool {
                allow members of "Servers";
                range %(net_prefix_drago)s.13 %(net_prefix_drago)s.13;
	}
        pool {
                allow members of "ServerPXE";
                range %(net_prefix_drago)s.14 %(net_prefix_drago)s.14;
	}

}
