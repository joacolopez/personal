# Configuracion para proxy local en filiales.
# Modificado para NodosVPN V5.1 -> Squid v3.1
# Basado en Version 1.3.10 - 15-12-2016 del NodoVPN v5 (Squid v2)
#	agrega soporte para totem de fe de vida - LINK.
#
# Version 1 - Febrero 2017
# 
# 
# Proyectos Especiales.
# Gerencia de tecnologia.
# Banco Credicoop Coop. Ltdo.

# Manejo de errores en castellano
# Squid2 -> error_directory /usr/share/squid/errors/Spanish
# Squid3
error_directory /usr/share/squid3/errors/es-ar

#====== Access List Control ==============================================
dns_v4_first on
# ---- ACLs Generales ----------------------------------------------------

# En Squid3 estaria embebida: acl all src 0.0.0.0/0
# No compatible con Squid3: acl manager proto cache_object
acl localhost src 127.0.0.0/8
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32
acl SSL_ports port 443 8443 21 20 9443 8140
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl Safe_ports port 8140	# puppet SCM
acl CONNECT method CONNECT
acl purge method PURGE

acl ftp proto FTP

acl our_networks src 10.0.0.0/8 127.0.0.0/8

# ==== ALCs en archivo externo ================================================
include /etc/squid3/squid.acl.conf

# Incluye:
# -------
# ACLs por clase (Prio1) => HiCritical
# 	prio1-FQDN 
#	prio1-IP 
# ACLs por clase (Prio2) => Critical
#	prio2-FQDN 
#	prio2-IP
# ACLs por clase (Bulk) => Default
#	LinkTotem-FQDN
#	bulk-FQDN
#	bulk-IP
#	bulk-QoS-REG
#	bulk-REG
# ACLs DIRECTO, Sin proxy padre (Bulk)
#	puppetmaster-FQDN
# ACLs Internet (red publica - Bulk y balanceo 2do vinculo)
#	InternetBandaHoraria-FQDN
#	InternetSinBandaHoraria-FQDN
#	InternetSinBandaHoraria-REG


# ==== GRUPOS PARA BANDAS HORARIAS ========================================
include /etc/squid3/GrupoHorario_.txt


# ==== Manejo de BANDAS HORARIAS ==========================================
# --- Uso de Internet para Todos --------------------------------
acl BandaHoraria_1 time 8:30-13:00
acl BandaHoraria_2 time 7:15-12:15
acl BandaHoraria_3 time 10:30-15:00

http_access deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_1 BandaHoraria_1 
http_access deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_2 BandaHoraria_2 
http_access deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_3 BandaHoraria_3 !GrupoHorario_1 !GrupoHorario_2

deny_info ERR_TIME_DENIED deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_1 BandaHoraria_1
deny_info ERR_TIME_DENIED deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_2 BandaHoraria_2 
deny_info ERR_TIME_DENIED deny InternetBandaHoraria-FQDN !bulk-FQDN !InternetSinBandaHoraria-FQDN GrupoHorario_3 BandaHoraria_3 

# ==== QoS UpStream por Cliente ===========================================
# Necesita Squid v3.2 o superior.
# Se comenta para Squid v2.7

#client_delay_pools 2

# Sin Limite (default)
#client_delay_class 1 -1/-1

# Cuota de subida: 50 Kbytes.
# Bandwidth subida: 128 kbps.
#client_delay_class 2 16384 51200

# Restriccion de Upstream
#client_delay_access 2 allow bulk-QoS-REG
#client_delay_access 2 deny all

# Sin Restriccion
#client_delay_access 1 deny bulk-QoS-REG
#client_delay_access 1 allow all

# ==== QoS DownStream por URL =============================================
delay_pools 3
delay_class 1 1
delay_class 2 2
delay_class 3 2

# Sin Limite
delay_parameters 1 -1/-1

# Ejemplo delay 2:
# Cuota libre de bajada individual: 102400 Bytes (100 Kbyes)
# Superada la cuota individual, pasa a tener 128kbps por estación.
# Cuota libre globlar: 153600 Bytes (150kBytes).
# Superada la cuota global, el BW pasa a 170Kbps (21760).
# delay_parameters 2 21760/153600 16384/102400
delay_parameters 2 {{bw_global_internet}}/{{cuota_global}} {{bw_individual_internet}}/{{cuota_individual}}

# Ejemplo delay 3:
# Pasando esto a terminos relativos, tomando un BW de 512Kbps seria:!!!!!!!
# Cuota libre individual: Debe tomar como max 2 segundos el canal
#              => a 512 Kbps => (512/8)*2 = 128 KBytes. | =BW/8*2
# Ancho de banda individual:
#              => a 512 Kbps => 100*200/512 = 39% | =BW*39/100
# Cuota libre global:
#              => a 512 Kbps => (512/8)*2*2 = 236 KBytes. | =BW/8*4
# Ancho de banda global:
#              => a 512 Kbps => 100*300/512 = 58% | =BW*58/100
# delay_parameters 3 296/236 199/128
# delay_parameters 3 BW_Global/Cuota_Global BW_Individual/Cuota_Individual
delay_parameters 3 {{bw_global_intranet}}/{{cuota_global}} {{bw_individual_intranet}}/{{cuota_individual}}

# Restriccion segun pool 3 (QoS - Zimbra) 
delay_access 3 allow bulk-QoS-REG
delay_access 3 deny all

# Con restriccion segun pool 2
delay_access 2 allow LinkTotem-FQDN
delay_access 2 allow InternetSinBandaHoraria-REG
delay_access 2 allow InternetSinBandaHoraria-FQDN
delay_access 2 allow InternetBandaHoraria-FQDN 
delay_access 2 deny all

# Sin limite por ser pool 1
delay_access 1 deny LinkTotem-FQDN
delay_access 1 deny bulk-QoS-REG
delay_access 1 deny InternetSinBandaHoraria-REG
delay_access 1 deny InternetSinBandaHoraria-FQDN
delay_access 1 deny InternetBandaHoraria-FQDN
delay_access 1 allow all

# ==== INCLUSION DE CASOS PARTICUALES =====================================
# Estudio Alzaga-Martinez, Segurcoop, DirectGroup, etc.

include /etc/squid3/*.squid.conf


# ==== PERMISOS para las ACLs =============================================
# ---- Default ---------------------------------------
http_access allow manager localhost
http_access allow purge localhost
http_access allow CONNECT localhost safe_ports puppetmaster-FQDN
http_access allow CONNECT InternetSinBandaHoraria-REG
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow our_networks LinkTotem-FQDN
http_access allow our_networks prio1-FQDN
http_access allow our_networks prio1-IP
http_access allow our_networks prio2-FQDN
http_access allow our_networks prio2-IP
http_access allow our_networks bulk-FQDN
http_access allow our_networks bulk-IP
http_access allow our_networks bulk-REG
http_access allow our_networks InternetSinBandaHoraria-FQDN 
http_access allow our_networks InternetSinBandaHoraria-REG 
http_access allow our_networks InternetBandaHoraria-FQDN 

http_access deny all

# ==== GENERALIDADES y DEMAS CONFIGURACIONES ================================
# Agrega a una URL con hostname (sin puntos) el dominio credicoop.
append_domain .bancocredicoop.coop

icp_access allow all

http_port 3128

dns_nameservers 127.0.0.1 10.1.1.3 10.1.1.9

balance_on_multiple_ip on

positive_dns_ttl 10 minutes
negative_dns_ttl 10 minutes


hierarchy_stoplist cgi-bin ?

acl QUERY urlpath_regex cgi-bin \?
cache deny QUERY

# legacy squid v2.7 -> cache_dir diskd /var/spool/squid 10000 16 256
cache_dir ufs /var/spool/squid3 10000 16 256
coredump_dir /var/spool/squid3

logfile_rotate 0

log_mime_hdrs off

# Agrega CGI-BIN con el cambio de version de squid.
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

#----No es compatible con squid v3----
#acl apache rep_header Server ^Apache
#broken_vary_encoding allow apache

forward_timeout 2 minutes

cache_effective_user proxy
cache_effective_group proxy

always_direct allow localhost puppetmaster-FQDN
always_direct deny all
never_direct allow all 

access_log /var/log/squid3/access.log squid
cache_log /var/log/squid3/cache.log
cache_store_log none


# ==== Proxies padre y manejo de prioridades ================================
# Este invoca al link que apunta a WanProxy o Proxyfil.bancocredicoop.coop --
include /etc/squid3/cache_peers.conf

# Distribución de tráfico por peer.------------------------------------------

cache_peer_access prio1 allow prio1-FQDN
cache_peer_access prio1 allow prio1-IP
cache_peer_access prio1 deny all

cache_peer_access prio2 deny prio1-FQDN
cache_peer_access prio2 deny prio1-IP
cache_peer_access prio2 deny bulk-QoS-REG
cache_peer_access prio2 allow prio2-FQDN
cache_peer_access prio2 allow prio2-IP
cache_peer_access prio2 deny all

cache_peer_access bulk allow bulk-QoS-REG
cache_peer_access bulk allow LinkTotem-FQDN
cache_peer_access bulk deny prio1-FQDN
cache_peer_access bulk deny prio1-IP
cache_peer_access bulk deny prio2-FQDN
cache_peer_access bulk deny prio2-IP
cache_peer_access bulk allow bulk-FQDN
cache_peer_access bulk allow bulk-IP
cache_peer_access bulk allow bulk-REG
cache_peer_access bulk allow !FTP bulk-SrvSegucoopFQDN
cache_peer_access bulk allow !FTP bulk-SrvSegucoopIP
cache_peer_access bulk allow InternetBandaHoraria-FQDN
cache_peer_access bulk allow InternetSinBandaHoraria-FQDN
cache_peer_access bulk allow InternetSinBandaHoraria-REG
cache_peer_access bulk deny all

httpd_suppress_version_string on

#visible_hostname NodoVPN

# DEBUG, argumento 1=seccion , argumento 2=vebosity 1 menos y 9 max.
#debug_options ALL,2 
#debug_options ALL,1 33,2

